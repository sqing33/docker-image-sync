name: å®šæœŸæ›´æ–° ghcr.io é•œåƒ

on:
  schedule:
    - cron: "0 16 * * *" # æ¯å¤© UTC æ—¶é—´ 16:00 è¿è¡Œ (åŒ—äº¬æ—¶é—´å‡Œæ™¨ 00:00)
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write # å†™å…¥ä»“åº“å†…å®¹ï¼ˆç”¨äºæ›´æ–° README.mdï¼‰
  packages: write # å†™å…¥/åˆ é™¤ GitHub Packages

jobs:
  check-and-update:
    runs-on: ubuntu-latest # åœ¨ Ubuntu æœ€æ–°ç‰ˆæœ¬ä¸Šè¿è¡Œ

    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4 # æ£€å‡ºä½ çš„ä»£ç ä»“åº“

      - name: å®‰è£…ä¾èµ–
        run: sudo apt-get install -y jq skopeo # å®‰è£… jq (å¤„ç† JSON) å’Œ skopeo (æ£€æŸ¥/å¤åˆ¶é•œåƒ)

      - name: æå–ç›®æ ‡é•œåƒåç§°ï¼ˆä» pull å‘½ä»¤åˆ—ï¼‰
        id: extract-target-images
        run: |
          awk -F '|' '
          /^### æœ¬ä»“åº“å·²åŒæ­¥çš„ Docker é•œåƒ/ {capture=1; next}
          capture && /^\| [0-9]+/ {
              # æå– pull é•œåƒåˆ—ï¼ˆç¬¬4åˆ—ï¼‰ï¼Œå»é™¤åŸŸåå’Œæ ‡ç­¾
              gsub(/^[ \t]+|[ \t]+$/, "", $4); # æ¸…é™¤é¦–å°¾ç©ºæ ¼
              gsub(/`/, "", $4); # æ¸…é™¤åå¼•å·
              # ç§»é™¤ ghcr.nju.edu.cn/sqing33/ å’Œå¯èƒ½çš„ :tag
              # æ³¨æ„ï¼šè¿™é‡Œçš„åŸŸåå’Œç”¨æˆ·å 'ghcr.nju.edu.cn/sqing33' éœ€è¦ä¸ä½ çš„å®é™…æƒ…å†µåŒ¹é…
              # github.repository_owner æ˜¯å°å†™çš„
              stripped_name = $4;
              gsub("ghcr.nju.edu.cn/${{ github.repository_owner }}/", "", stripped_name);
              gsub(":[^:]*$", "", stripped_name); # ç§»é™¤ :tag
              print stripped_name
          }
          /^###/ {capture=0} # é‡åˆ°ä¸‹ä¸€ä¸ª ### æ ‡é¢˜å°±åœæ­¢æ•è·
          ' README.md | grep -vE '^(æºé•œåƒ|---.*)$' | sed '/^$/d' > target-image-list.txt
          echo "===== target-image-list.txt å†…å®¹ ====="
          cat target-image-list.txt

      - name: æå–æºé•œåƒåç§°ï¼ˆä»æºé•œåƒåˆ—ï¼‰
        id: extract-source-images
        run: |
          awk -F '|' '
          /^### æœ¬ä»“åº“å·²åŒæ­¥çš„ Docker é•œåƒ/ {capture=1; next}
          capture && /^\| [0-9]+/ {
              # æå–æºé•œåƒåˆ—ï¼ˆç¬¬2åˆ—ï¼‰ï¼Œå»é™¤å¯èƒ½çš„åå¼•å·å’Œç©ºæ ¼
              gsub(/^[ \t]+|[ \t]+$/, "", $2);
              gsub(/`/, "", $2);
              print $2
          }
          /^###/ {capture=0}
          ' README.md | grep -vE '^(æºé•œåƒ|---.*)$' | sed '/^$/d' > source-image-list.txt
          echo "===== source-image-list.txt å†…å®¹ ====="
          cat source-image-list.txt

      - name: åˆå¹¶é•œåƒåˆ—è¡¨
        run: |
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”éç©º
          if [ ! -s source-image-list.txt ] || [ ! -s target-image-list.txt ]; then
            echo "é”™è¯¯ï¼šsource-image-list.txt æˆ– target-image-list.txt ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
            exit 1
          fi
          # ä½¿ç”¨ paste åˆå¹¶ï¼Œç”¨ '|' åˆ†éš”
          paste -d '|' source-image-list.txt target-image-list.txt > combined-list.txt
          echo "===== combined-list.txt å†…å®¹ ====="
          cat combined-list.txt

      - name: ç™»å½•åˆ° GitHub å®¹å™¨æ³¨å†Œè¡¨
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }} # ä½¿ç”¨ä»“åº“æ‰€æœ‰è€…ä½œä¸º GHCR ç”¨æˆ·å
          password: ${{ secrets.GITHUB_TOKEN }}Â  Â  # ä½¿ç”¨ GitHub Actions é»˜è®¤ token

      - name: æ¸…ç†å·²åˆ é™¤çš„é•œåƒæ¡ç›® (ä» README)
        env:
          GHCR_USER: ${{ github.repository_owner }}
        run: |
          # é¦–å…ˆæ£€æŸ¥ README ä¸­æ˜¯å¦æœ‰ä»»ä½•é•œåƒæ¡ç›®ï¼Œå¦‚æœæ²¡æœ‰åˆ™è·³è¿‡æ­¤æ¸…ç†æ­¥éª¤
          if [ ! -s target-image-list.txt ]; then
            echo "README ä¸­æ²¡æœ‰é•œåƒæ¡ç›®ï¼Œè·³è¿‡æ¸…ç†å·²åˆ é™¤çš„é•œåƒæ¡ç›®ã€‚"
            exit 0
          fi

          touch keep-images.txt
          touch deleted-images.txt # åˆå§‹åŒ– deleted-images.txt

          # éå† README ä¸­åˆ—å‡ºçš„æ¯ä¸ªç›®æ ‡é•œåƒ
          while IFS= read -r target_image; do
            # æ„å»ºå®Œæ•´çš„ ghcr.io è·¯å¾„ (GHCR ç”¨æˆ·åé€šå¸¸æ˜¯å°å†™)
            GHCR_FULL_IMAGE_PATH="ghcr.io/$(echo "$GHCR_USER" | tr 'A-Z' 'a-z')/$target_image"
            
            # ä½¿ç”¨ skopeo æ£€æŸ¥ ghcr.io ä¸Šæ˜¯å¦å­˜åœ¨æ­¤é•œåƒçš„ latest æ ‡ç­¾
            # ä½¿ç”¨ 2>/dev/null æŠ‘åˆ¶ skopeo çš„é”™è¯¯è¾“å‡ºï¼Œåªå…³æ³¨ exit code
            if skopeo inspect "docker://$GHCR_FULL_IMAGE_PATH:latest" >/dev/null 2>&1; then
              echo "$target_image" >> keep-images.txt
            else
              echo "é•œåƒ $target_image ä¸å­˜åœ¨äºghcr.io (latest æ ‡ç­¾)ï¼Œæ ‡è®°ä¸ºåˆ é™¤"
              echo "$target_image" >> deleted-images.txt
            fi
          done < target-image-list.txt

          mv keep-images.txt target-image-list.txt # æ›´æ–° target-image-list.txt ä»¥ä¾›åç»­ä½¿ç”¨

          # å¦‚æœå­˜åœ¨éœ€è¦ä» README ä¸­åˆ é™¤çš„æ¡ç›®
          if [ -s deleted-images.txt ]; then
            echo "å¼€å§‹æ¸…ç† README ä¸­çš„æ— æ•ˆæ¡ç›®..."
            TEMP_README_FILE="README.tmp"

            # å‡†å¤‡ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶æ¥å­˜å‚¨æ›´æ–°åçš„ README å†…å®¹
            awk -F '|' -v del_file="deleted-images.txt" '
              BEGIN {
                while ((getline < del_file) > 0) {
                  deleted_images[$0] = 1
                }
                close(del_file)
                capture = 0
                count = 0
              }
              /^### æœ¬ä»“åº“å·²åŒæ­¥çš„ Docker é•œåƒ/ {
                print
                capture = 1
                next
              }
              capture && /^\| *----/ { # åŒ¹é…åˆ†éš”çº¿
                print
                next
              }
              capture && /^\| *[0-9]+/ { # åŒ¹é…æ•°æ®è¡Œ
                # æå– pull é•œåƒåˆ—ï¼Œå¹¶å»é™¤åŸŸåå’Œæ ‡ç­¾ï¼Œä¸ deleted-images.txt ä¸­çš„æ ¼å¼åŒ¹é…
                line_target_image = $4;
                gsub(/^[ \t]+|[ \t]+$/, "", line_target_image);
                gsub(/`/, "", line_target_image);
                # ç§»é™¤ ghcr.nju.edu.cn/sqing33/ å’Œå¯èƒ½çš„ :tag
                # æ³¨æ„ï¼šè¿™é‡Œçš„åŸŸåå’Œç”¨æˆ·å 'ghcr.nju.edu.cn/sqing33' éœ€è¦ä¸ä½ çš„å®é™…æƒ…å†µåŒ¹é…
                # github.repository_owner æ˜¯å°å†™çš„
                gsub("ghcr.nju.edu.cn/${{ github.repository_owner }}/", "", line_target_image);
                gsub(":[^:]*$", "", line_target_image); # ç§»é™¤ :tag

                if (deleted_images[line_target_image]) {
                  print "è·³è¿‡åˆ é™¤çš„è¡Œ: " $0 > "/dev/stderr" # è°ƒè¯•è¾“å‡º
                  next # è·³è¿‡è¿™æ¡åˆ é™¤çš„è¡Œ
                } else {
                  count++ # é‡æ–°ç¼–å·
                  # é‡æ–°æ„å»ºè¡Œï¼Œä¿®æ­£ç¼–å·
                  printf "| %s |%s|%s|%s\n", count, $2, $3, $4 # æ³¨æ„è¿™é‡Œå¯èƒ½éœ€è¦æ ¹æ®å®é™…åˆ—æ•°è°ƒæ•´
                  next
                }
              }
              capture && /^[ \t]*$/ { # æ•è·è¡¨æ ¼æœ«å°¾çš„ç©ºè¡Œï¼Œé˜²æ­¢ awk åæ‰
                 print
                 capture = 0
                 next
              }
              { print } # æ‰“å°å…¶ä»–è¡Œ
            ' README.md > "$TEMP_README_FILE"
            
            mv "$TEMP_README_FILE" README.md

            # æäº¤æ›´æ”¹
            git config --global user.name "GitHub Actions"
            git config --global user.email "actions@github.com"
            git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
            git add README.md
            git commit -m "docs: è‡ªåŠ¨æ¸…ç†å·²åˆ é™¤çš„é•œåƒæ¡ç›®å¹¶é‡æ–°ç¼–å· README" || echo "æ— å˜æ›´å¯æäº¤" # å¦‚æœæ²¡æœ‰ä¿®æ”¹ï¼Œåˆ™ä¸æäº¤
            git push origin main || echo "æœªèƒ½æ¨é€åˆ° main åˆ†æ”¯ï¼Œå¯èƒ½æ— å˜æ›´æˆ–å­˜åœ¨å†²çª"

            # ä» combined-list.txt åˆ é™¤å·²æ ‡è®°çš„æ¡ç›®ï¼Œä»¥ä¾¿åç»­æ­¥éª¤ä¸å†å¤„ç†
            # è¿™é‡Œçš„ target_image-list.txt å·²ç»æ›´æ–°è¿‡ï¼Œç›´æ¥ç”¨å®ƒæ¥è¿‡æ»¤ combined-list.txt å³å¯
            # é‡æ–°ç”Ÿæˆ combined-list.txt
            paste -d '|' source-image-list.txt target-image-list.txt > combined-list.tmp
            mv combined-list.tmp combined-list.txt

          else
            echo "æ— éœ€è¦ä» README æ¸…ç†çš„æ¡ç›®"
          fi

      - name: åŒæ­¥æ‰€æœ‰æ¶æ„é•œåƒæ›´æ–°
        env:
          GHCR_USER: ${{ github.repository_owner }}
        run: |
          echo "===== åŒæ­¥é•œåƒåˆ—è¡¨ ====="
          cat combined-list.txt
          echo "===================="

          # ç¡®ä¿ combined-list.txt éç©ºï¼Œé¿å… IFS é”™è¯¯
          if [ ! -s combined-list.txt ]; then
            echo "combined-list.txt ä¸ºç©ºï¼Œè·³è¿‡é•œåƒåŒæ­¥ã€‚"
            exit 0
          fi

          while IFS='|' read -r source_image target_image; do
            echo "å¤„ç†é•œåƒ: $target_image (æºé•œåƒ: $source_image)"
            source_image_full="docker://$source_image:latest" # é»˜è®¤æ‹‰å– latest
            target_image_base="ghcr.io/$(echo "$GHCR_USER" | tr 'A-Z' 'a-z')/$target_image"
            need_update=false

            # è·å–æºé•œåƒçš„æ¸…å•ï¼ˆmanifestï¼‰
            # å¢åŠ å¯¹ skopeo inspect é”™è¯¯çš„æ•è·
            if ! source_manifest=$(skopeo inspect --raw "$source_image_full" 2>/dev/null); then
              echo "âŒ è­¦å‘Šï¼šæ— æ³•è·å–æºé•œåƒ $source_image_full çš„æ¸…å•ï¼Œå¯èƒ½é•œåƒä¸å­˜åœ¨æˆ–ç½‘ç»œé—®é¢˜ã€‚è·³è¿‡æ­¤é•œåƒã€‚"
              continue
            fi
            source_digest=$(echo "$source_manifest" | jq -r '.digest // empty')

            # æ£€æŸ¥ç›®æ ‡é•œåƒæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™è·å–å…¶æ¸…å•
            if target_manifest=$(skopeo inspect --raw "docker://$target_image_base:latest" 2>/dev/null); then
              target_digest=$(echo "$target_manifest" | jq -r '.digest // empty')
            else
              target_digest=""
            fi

            # æ¯”è¾ƒæ¸…å• digestï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°
            if [ "$source_digest" != "$target_digest" ]; then
              echo "æ£€æµ‹åˆ°æ¸…å•æ›´æ–° (æº: $source_digest, ç›®æ ‡: $target_digest)ï¼Œå¼€å§‹å…¨æ¶æ„åŒæ­¥..."
              need_update=true
            else
              echo "æ¸…å•æœªæ›´æ–°ï¼Œè·³è¿‡åŒæ­¥"
              continue # è·³è¿‡å½“å‰é•œåƒï¼Œå¤„ç†ä¸‹ä¸€ä¸ª
            fi

            # è·å–æ‰€æœ‰æ”¯æŒçš„æ¶æ„ï¼ˆå¤„ç†åµŒå¥—æ¸…å•åˆ—è¡¨ï¼‰
            if echo "$source_manifest" | jq -e '.manifests' > /dev/null 2>&1; then
              # å¦‚æœæ˜¯å¤šæ¶æ„æ¸…å•ï¼Œæå–æ‰€æœ‰æœ‰æ•ˆæ¶æ„
              ARCHS=$(echo "$source_manifest" | jq -r '.manifests[].platform.architecture' | sort -u | grep -E 'amd64|arm64|armv7|arm|386|ppc64le|s390x|mips64le')
            else
              # å¦‚æœæ˜¯å•æ¶æ„é•œåƒï¼Œç›´æ¥æå–æ¶æ„
              ARCH=$(echo "$source_manifest" | jq -r '.architecture')
              ARCHS=$( [[ "$ARCH" =~ ^(amd64|arm64|armv7|arm|386|ppc64le|s390x|mips64le)$ ]] && echo "$ARCH" || echo "")
            fi

            # å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ”¯æŒçš„æ¶æ„ï¼Œåˆ™é»˜è®¤ä½¿ç”¨ amd64
            if [ -z "$ARCHS" ]; then
              echo "âŒ æœªæ‰¾åˆ°æ”¯æŒçš„æ¶æ„ï¼Œä½¿ç”¨é»˜è®¤æ¶æ„ amd64"
              ARCHS="amd64"
            fi

            declare -a SYNCED_ARCH_TAGS=() # ç”¨äºæ„å»ºæœ€ç»ˆ manifest çš„æ ‡ç­¾åˆ—è¡¨
            # å¾ªç¯åŒæ­¥å„æ¶æ„é•œåƒ
            for arch in $ARCHS; do
              echo "â–¸ å¤„ç†æ¶æ„: $arch"
              # ghcr.io ä¸Šçš„ä¸´æ—¶æ ‡ç­¾
              TARGET_TEMP_TAG="$target_image_base:latest-$arch"

              # è·å–æ¶æ„ç‰¹å®šçš„ digest
              # è€ƒè™‘ arm å’Œ armv7 çš„æƒ…å†µ
              CURRENT_ARCH_DIGEST=$(echo "$source_manifest" | jq -r \
                --arg arch "$arch" \
                '.manifests[] | select(.platform.architecture == $arch or (.platform.architecture == "armv7" and $arch == "arm")).digest')

              if [ -z "$CURRENT_ARCH_DIGEST" ]; then
                 echo "âš ï¸ è­¦å‘Šï¼šæ¶æ„ $arch ä¸å­˜åœ¨äºæºé•œåƒä¸­ï¼Œå·²è·³è¿‡æ­¤æ¶æ„çš„åŒæ­¥ã€‚"
                 continue
              fi

              # æ‹‰å–å¹¶æ¨é€æ¶æ„é•œåƒ
              # ä½¿ç”¨ skopeo copy æ›´ç›´æ¥é«˜æ•ˆï¼Œé¿å… Docker daemon çš„é¢å¤–æ­¥éª¤
              # skopeo copy --all-tags å¤åˆ¶æ‰€æœ‰æ ‡ç­¾ï¼Œä½†è¿™é‡Œæˆ‘ä»¬åªå¤„ç† latest
              # skopeo copy --preserve-digests
              echo "skopeo copy docker://${source_image}@${CURRENT_ARCH_DIGEST} docker://${TARGET_TEMP_TAG}"
              if skopeo copy "docker://${source_image}@${CURRENT_ARCH_DIGEST}" "docker://${TARGET_TEMP_TAG}"; then
                echo "âœ… å·²åŒæ­¥ $arch æ¶æ„åˆ° $TARGET_TEMP_TAG"
                SYNCED_ARCH_TAGS+=("$TARGET_TEMP_TAG")
              else
                echo "âŒ é”™è¯¯ï¼šåŒæ­¥ $arch æ¶æ„å¤±è´¥ï¼Œè·³è¿‡ã€‚"
              fi
            done

            # å¦‚æœæ²¡æœ‰æˆåŠŸåŒæ­¥ä»»ä½•æ¶æ„ï¼Œåˆ™è·³è¿‡ manifest åˆ›å»º
            if [ ${#SYNCED_ARCH_TAGS[@]} -eq 0 ]; then
                echo "âš ï¸ è­¦å‘Šï¼šæ­¤é•œåƒæœªæˆåŠŸåŒæ­¥ä»»ä½•æ¶æ„ï¼Œè·³è¿‡åˆ›å»ºå¤šæ¶æ„ manifestã€‚"
                continue
            fi

            # æ›´æ–°å¤šæ¶æ„ manifest åˆ—è¡¨
            echo "ğŸ”„ é‡å»ºå¤šæ¶æ„ manifest åˆ—è¡¨..."
            # å°è¯•åˆ é™¤æ—§çš„ manifest åˆ—è¡¨ï¼Œå¿½ç•¥é”™è¯¯
            docker manifest rm "$target_image_base:latest" 2>/dev/null || true

            amend_args=()
            for tag in "${SYNCED_ARCH_TAGS[@]}"; do
              amend_args+=(--amend "$tag")
            done

            # åˆ›å»ºæ–°çš„å¤šæ¶æ„ manifest
            # å¯¹äº ghcr.ioï¼Œé€šå¸¸ä¸éœ€è¦ --insecure
            if docker manifest create "$target_image_base:latest" "${amend_args[@]}"; then
              echo "ğŸšš æ¨é€æ–°çš„å¤šæ¶æ„ manifest..."
              docker manifest push "$target_image_base:latest"
              echo "âœ… åŒæ­¥å®Œæˆ: $target_image_base:latest"
            else
              echo "âŒ é”™è¯¯ï¼šåˆ›å»ºæˆ–æ¨é€å¤šæ¶æ„ manifest å¤±è´¥ã€‚"
            fi
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          done < combined-list.txt

      - name: åˆ é™¤ ghcr.io ä¸Š README æœªåˆ—å‡ºçš„é•œåƒåŒ…
        env:
          GHCR_USER: ${{ github.repository_owner }} # ä»“åº“æ‰€æœ‰è€…
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}Â  Â  Â # GitHub Actions é»˜è®¤ token
        run: |
          echo "===== æ£€æŸ¥ ghcr.io ä¸Šæ‰€æœ‰åŒ… ====="
          # è·å– README ä¸­åº”ä¿ç•™çš„é•œåƒå (å†æ¬¡ä»æ›´æ–°åçš„ target-image-list.txt è¯»å–)
          cat target-image-list.txt | sort > keep-list.txt

          # æ‰“å°æœ€ç»ˆçš„ API è·¯å¾„ï¼Œä»¥ä¾¿è°ƒè¯•
          API_LIST_PATH="/users/$(echo "$GHCR_USER" | tr 'A-Z' 'a-z')/packages?package_type=container&per_page=100"
          echo "å°†è°ƒç”¨çš„ gh api åˆ—è¡¨è·¯å¾„: ${API_LIST_PATH}"

          echo "æ­£åœ¨ä» ghcr.io è·å–åŒ…åˆ—è¡¨..."
          if ! gh api \
            -H "Accept: application/vnd.github+json" \
            "${API_LIST_PATH}" \
            --verbose > ghcr_packages.json 2> debug_ghcr_packages_list.log; then
            echo "é”™è¯¯ï¼šgh api è·å–åŒ…åˆ—è¡¨å¤±è´¥ã€‚"
            echo "gh api è°ƒè¯•æ—¥å¿—ï¼ˆè·å–åˆ—è¡¨ï¼‰ï¼š"
            cat debug_ghcr_packages_list.log # è¾“å‡ºè°ƒè¯•æ—¥å¿—
            exit 1 # ç«‹å³é€€å‡ºï¼Œé¿å…åç»­æ­¥éª¤å› æ–‡ä»¶å†…å®¹é—®é¢˜è€ŒæŠ¥é”™
          fi

          # æ£€æŸ¥ ghcr_packages.json æ˜¯å¦å­˜åœ¨ä¸”å†…å®¹æœ‰æ•ˆ
          if [ ! -s ghcr_packages.json ]; then
            echo "é”™è¯¯ï¼šghcr_packages.json ä¸ºç©ºæˆ–ä¸å­˜åœ¨ã€‚"
            cat debug_ghcr_packages_list.log # å†æ¬¡è¾“å‡ºé”™è¯¯æ—¥å¿—
            exit 1
          fi

          if ! jq empty ghcr_packages.json 2>/dev/null; then
            echo "é”™è¯¯ï¼šghcr_packages.json å†…å®¹ä¸æ˜¯æœ‰æ•ˆçš„ JSONã€‚"
            echo "æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š"
            cat ghcr_packages.json
            echo "gh api è°ƒè¯•æ—¥å¿—ï¼ˆè·å–åˆ—è¡¨ï¼‰ï¼š"
            cat debug_ghcr_packages_list.log # å†æ¬¡è¾“å‡ºé”™è¯¯æ—¥å¿—
            exit 1
          fi

          # ä» API å“åº”ä¸­æå–åŒ…åå¹¶æ’åº
          jq -r '.[].name' ghcr_packages.json | sort > ghcr-list.txt

          echo "åœ¨ ghcr.io ä¸Šæ‰¾åˆ°çš„åŒ…ï¼š"
          cat ghcr-list.txt
          echo "åº”è¯¥ä¿ç•™çš„åŒ… (æ¥è‡ª README)ï¼š"
          cat keep-list.txt

          # æ‰¾å‡ºéœ€è¦åˆ é™¤çš„åŒ…ï¼ˆghcr.io ä¸Šæœ‰ä½† README æ²¡æœ‰çš„ï¼‰
          # comm -23 è¡¨ç¤ºæ‰¾å‡º ghcr-list.txt ä¸­æœ‰ä½† keep-list.txt ä¸­æ²¡æœ‰çš„è¡Œ
          comm -23 ghcr-list.txt keep-list.txt > to-delete.txt

          if [ -s to-delete.txt ]; then
            echo "éœ€è¦åˆ é™¤çš„åŒ…ï¼š"
            cat to-delete.txt
            while IFS= read -r pkg; do
              # æ„å»ºæ­£ç¡®çš„åˆ é™¤ API è·¯å¾„
              DELETE_API_PATH="/users/$(echo "$GHCR_USER" | tr 'A-Z' 'a-z')/packages/container/${pkg}"
              echo "æ­£åœ¨åˆ é™¤ ghcr.io ä¸Šçš„åŒ…: $pkg (API è·¯å¾„: ${DELETE_API_PATH})"
              
              # æ‰§è¡Œåˆ é™¤æ“ä½œ
              if ! gh api \
                -X DELETE \
                -H "Accept: application/vnd.github+json" \
                "${DELETE_API_PATH}" \
                --silent \
                --verbose 2>> debug_ghcr_packages_delete.log; then # å°†åˆ é™¤æ“ä½œçš„è°ƒè¯•è¾“å‡ºä¹Ÿè¿½åŠ åˆ°æ—¥å¿—æ–‡ä»¶
                echo "åˆ é™¤ $pkg å¤±è´¥ï¼Œå¯èƒ½æ— æƒé™æˆ–åŒ…ä¸å­˜åœ¨ã€‚è¯·æ£€æŸ¥ debug_ghcr_packages_delete.logã€‚"
                cat debug_ghcr_packages_delete.log
              else
                echo "âœ… å·²æˆåŠŸåˆ é™¤ ghcr.io ä¸Šçš„åŒ…: $pkg"
              fi
            done < to-delete.txt
          else
            echo "æ— éœ€è¦åˆ é™¤çš„åŒ…"
          fi
