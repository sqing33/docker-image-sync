name: æ›´æ–° Docker é•œåƒ â†’ å®šæ—¶æ›´æ–° ghcr.io

on:
  schedule:
    # æ¯å¤©çš„ UTC æ—¶é—´ 16:00 (åŒ—äº¬æ—¶é—´ 00:00) è¿è¡Œ
    - cron: "0 16 * * *"
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 2. å®‰è£…ä¾èµ–
        run: sudo apt-get update && sudo apt-get install -y jq skopeo

      - name: 3. æå–ç›®æ ‡é•œåƒåç§° (ä» Pull å‘½ä»¤åˆ—)
        id: extract-target-images
        run: |
          owner_lowercase=$(echo "${{ github.repository_owner }}" | tr 'A-Z' 'a-z')
          awk -F '|' '
          /^### å·²åŒæ­¥çš„ Docker é•œåƒ/ {capture=1; next}
          capture && /^\| [0-9]+/ {
              # åªå¤„ç†åŒæ­¥åˆ—ä¸ºâœ”ï¸çš„è¡Œ
              sync_col=$6; gsub(/^[ \t]+|[ \t]+$/, "", sync_col);
              if (sync_col != "âœ”ï¸") next;
              # æå– pull é•œåƒåˆ—
              gsub(/^[ \t]+|[ \t]+$/, "", $4);
              gsub(/`/, "", $4);
              print $4
          }
          # é‡åˆ°ä¸‹ä¸€ä¸ªæ ‡é¢˜æ—¶åœæ­¢
          /^### / && capture && !/å·²åŒæ­¥/ {capture=0}
          ' README.md | grep -vE '^æºé•œåƒ$|^-+$' | sed '/^$/d' | \
          # æå–é•œåƒåç§°ï¼ˆå»é™¤åŸŸåå’Œæ ‡ç­¾ï¼‰
          sed "s|^ghcr.io/$owner_lowercase/||" | \
          sed 's/:[^:]*$//' > target-image-list.txt
          echo "===== å°†è¦æ£€æŸ¥çš„ç›®æ ‡é•œåƒåˆ—è¡¨ ====="
          cat target-image-list.txt

      - name: 4. æå–æºé•œåƒåç§° (ä»æºé•œåƒåˆ—)
        id: extract-source-images
        run: |
          awk -F '|' '
          /^### å·²åŒæ­¥çš„ Docker é•œåƒ/ {capture=1; next}
          capture && /^\| [0-9]+/ {
              # åªå¤„ç†åŒæ­¥åˆ—ä¸ºâœ”ï¸çš„è¡Œ
              sync_col=$6; gsub(/^[ \t]+|[ \t]+$/, "", sync_col);
              if (sync_col != "âœ”ï¸") next;
              # æå–æºé•œåƒåˆ—
              gsub(/^[ \t]+|[ \t]+$/, "", $3);
              gsub(/`/, "", $3);
              print $3
          }
          # é‡åˆ°ä¸‹ä¸€ä¸ªæ ‡é¢˜æ—¶åœæ­¢
          /^### / && capture && !/å·²åŒæ­¥/ {capture=0}
          ' README.md | grep -vE '^æºé•œåƒ$|^-+$' | sed '/^$/d' > source-image-list.txt
          echo "===== å¯¹åº”çš„æºé•œåƒåˆ—è¡¨ ====="
          cat source-image-list.txt

      - name: 5. åˆå¹¶é•œåƒåˆ—è¡¨
        run: |
          if [ ! -s source-image-list.txt ] || [ ! -s target-image-list.txt ]; then
            echo "é”™è¯¯ï¼šæºæˆ–ç›®æ ‡é•œåƒåˆ—è¡¨ä¸ºç©ºï¼Œè¯·æ£€æŸ¥ README.md è¡¨æ ¼æ ¼å¼ã€‚"
            exit 1
          fi
          paste -d '|' source-image-list.txt target-image-list.txt > combined-list.txt
          echo "===== åˆå¹¶åçš„é•œåƒæ£€æŸ¥åˆ—è¡¨ ====="
          cat combined-list.txt

      - name: 6. ç™»å½•åˆ° Docker Hub
        # ---
        # æ ¸å¿ƒä¿®æ­£ï¼šå°† if æ¡ä»¶ç”¨ ${{...}} åŒ…è£¹
        # ---
        if: ${{ secrets.DOCKERHUB_USERNAME != '' && secrets.DOCKERHUB_TOKEN != '' }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: 7. ç™»å½•åˆ° GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: 8. æ¸…ç† README.md ä¸­å·²å¤±æ•ˆçš„é•œåƒæ¡ç›®
        env:
          GHCR_USER: ${{ github.repository_owner }}
        run: |
          owner_lowercase=$(echo "$GHCR_USER" | tr 'A-Z' 'a-z')
          while IFS= read -r target_image; do
            target_image_base="ghcr.io/$owner_lowercase/$target_image"
            # æ£€æŸ¥è¿œç«¯é•œåƒæ˜¯å¦å­˜åœ¨
            if ! skopeo inspect "docker://$target_image_base:latest" --no-tags >/dev/null 2>&1; then
              echo "é•œåƒ $target_image_base ä¸å­˜åœ¨äº ghcr.ioï¼Œæ ‡è®°ä¸ºåˆ é™¤ã€‚"
              # ä½¿ç”¨ grep å’Œ sed æŸ¥æ‰¾å¹¶åˆ é™¤åŒ…å«è¯¥é•œåƒåç§°çš„è¡Œ
              escaped_name=$(printf '%s\n' "$target_image_base" | sed 's:[][\\/.^$*]:\\&:g')
              # ç›´æ¥æ“ä½œï¼Œæ‰¾åˆ°åˆ™åˆ é™¤
              if grep -q "$escaped_name" README.md; then
                  sed -i "/$escaped_name/d" README.md
                  echo "$target_image" >> deleted-images.txt
              fi
            fi
          done < target-image-list.txt

          if [ -f deleted-images.txt ]; then
            echo "å·²æ¸…ç†å¤±æ•ˆæ¡ç›®ï¼Œæ­£åœ¨é‡æ–°ç¼–å·å¹¶æäº¤..."
            # é‡æ–°ç¼–å·è¡¨æ ¼
            awk 'BEGIN { FS=OFS="|"; in_table=0; count=0 }
              /^### å·²åŒæ­¥çš„ Docker é•œåƒ/ { in_table=1 }
              !in_table { print; next }
              in_table && /^\| *[0-9]+/ {
                count++;
                $2 = " " count " "; # é‡æ–°ç¼–å·
                print;
                next
              }
              in_table && !/^\| *[0-9]+/ {
                 # æ£€æŸ¥æ˜¯å¦ç¦»å¼€è¡¨æ ¼åŒºåŸŸ
                 if ($0 !~ /^\|/) { in_table=0 }
              }
              { print }' README.md > README.tmp && mv README.tmp README.md

            git config --global user.name "github-actions[bot]"
            git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add README.md
            git commit -m "chore: è‡ªåŠ¨æ¸…ç† README.md ä¸­å·²å¤±æ•ˆçš„é•œåƒè®°å½•" || echo "æ— å˜æ›´å¯æäº¤"
            git push
          else
            echo "æ²¡æœ‰åœ¨ README.md ä¸­æ‰¾åˆ°å¤±æ•ˆçš„é•œåƒæ¡ç›®ã€‚"
          fi

      - name: 9. åŒæ­¥æ‰€æœ‰æ¶æ„é•œåƒæ›´æ–°
        env:
          GHCR_USER: ${{ github.repository_owner }}
        run: |
          # ç¡®ä¿ä»»ä½•å‘½ä»¤å¤±è´¥éƒ½ä¼šç«‹åˆ»ç»ˆæ­¢è„šæœ¬
          set -eo pipefail

          echo "===== å¼€å§‹åŒæ­¥é•œåƒ ====="
          
          while IFS='|' read -r source_image target_image; do
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            echo "å¤„ç†é•œåƒ: $target_image (æºé•œåƒ: $source_image)"
            
            if [[ "$source_image" == *:* ]]; then
              source_image_full="docker://$source_image"
            else
              source_image_full="docker://$source_image:latest"
            fi
            owner_lowercase=$(echo "$GHCR_USER" | tr 'A-Z' 'a-z')
            target_image_base="ghcr.io/$owner_lowercase/$target_image"
            
            echo "æ­£åœ¨æ£€æŸ¥æºé•œåƒ: $source_image_full"
            source_digest=$(skopeo inspect "$source_image_full" 2>/dev/null | jq -r '.Digest // empty')
            echo "æºé•œåƒ Digest: $source_digest"

            echo "æ­£åœ¨æ£€æŸ¥ç›®æ ‡é•œåƒ: docker://$target_image_base:latest"
            target_digest=$(skopeo inspect "docker://$target_image_base:latest" 2>/dev/null | jq -r '.Digest // empty')
            echo "ç›®æ ‡é•œåƒ Digest: $target_digest"

            if [ -z "$source_digest" ]; then
              echo "âŒ é”™è¯¯ï¼šæ— æ³•è·å–æºé•œåƒçš„ digestï¼Œå¯èƒ½é•œåƒä¸å­˜åœ¨æˆ–ç½‘ç»œé—®é¢˜ï¼Œå·²è·³è¿‡ã€‚"
              continue
            fi

            if [ "$source_digest" != "$target_digest" ]; then
              echo "âœ… æ£€æµ‹åˆ°æ¸…å•æ›´æ–° ($source_digest != $target_digest)ï¼Œå¼€å§‹å…¨æ¶æ„åŒæ­¥..."
            else
              echo "æ¸…å•æœªæ›´æ–°ï¼Œè·³è¿‡åŒæ­¥ã€‚"
              continue
            fi

            # åªæœ‰åœ¨éœ€è¦æ›´æ–°æ—¶ï¼Œæ‰è·å–åŸå§‹æ¸…å•ç”¨äºè§£ææ¶æ„
            source_manifest=$(skopeo inspect --raw "$source_image_full")
            
            if echo "$source_manifest" | jq -e '.manifests' > /dev/null 2>&1; then
              # å¤šæ¶æ„æ¸…å•
              ARCHS=$(echo "$source_manifest" | jq -r '.manifests[].platform.architecture' | sort -u | grep -E 'amd64|arm64|armv7|arm|386|ppc64le|s390x|mips64le')
            else
              # å•æ¶æ„æ¸…å•
              ARCH=$(echo "$source_manifest" | jq -r '.architecture')
              ARCHS=$( [[ "$ARCH" =~ ^(amd64|arm64|armv7|arm|386|ppc64le|s390x|mips64le)$ ]] && echo "$ARCH" || echo "")
            fi
            
            if [ -z "$ARCHS" ]; then
              echo "âš ï¸ æœªæ‰¾åˆ°æœ‰æ•ˆæ¶æ„ï¼Œå°†ä½œä¸ºå•æ¶æ„é•œåƒå¤„ç†ã€‚"
              ARCHS="default" # ä½¿ç”¨ä¸€ä¸ªç‰¹æ®Šå€¼æ¥æ ‡è®°å•æ¶æ„
            fi

            echo "å¼€å§‹åŒæ­¥æ¶æ„: $ARCHS"
            amend_args=() # ç”¨äºæ„å»º manifest çš„å‚æ•°

            for arch in $ARCHS; do
              source_image_name=$(echo "$source_image_full" | sed 's|docker://||')
              
              if [[ "$arch" == "default" ]]; then
                 # å•æ¶æ„æƒ…å†µ
                 arch_digest=$source_digest
                 target_tag="$target_image_base:latest-amd64" # å‡è®¾é»˜è®¤ä¸ºamd64
                 amend_args+=(--amend "$target_tag")
              else
                 # å¤šæ¶æ„æƒ…å†µ
                 echo "â–¸ å¤„ç†æ¶æ„: $arch"
                 target_tag="$target_image_base:latest-$arch"
                 arch_digest=$(echo "$source_manifest" | jq -r \
                    --arg arch "$arch" \
                    '.manifests[] | select(.platform.architecture == $arch or (.platform.architecture == "armv7" and $arch == "arm")).digest')
                 if [ -z "$arch_digest" ]; then
                    arch_digest=$(echo "$source_manifest" | jq -r \
                      --arg arch "$arch" \
                      '.manifests[] | select(.platform.variant? == "v7" and $arch == "arm").digest')
                 fi
                 amend_args+=(--amend "$target_tag")
              fi

              if [ -z "$arch_digest" ]; then
                 echo "âš ï¸ è­¦å‘Šï¼šæ— æ³•å®šä½æ¶æ„ $arch çš„ digestï¼Œå·²è·³è¿‡"
                 continue
              fi

              echo "æ‹‰å–: $source_image_name@$arch_digest"
              docker pull "$source_image_name@$arch_digest"
              docker tag "$source_image_name@$arch_digest" "$target_tag"
              docker push "$target_tag"
            done
            
            echo "ğŸ”„ é‡å»ºå¤šæ¶æ„ manifest åˆ—è¡¨..."
            docker manifest rm "$target_image_base:latest" 2>/dev/null || true
            docker manifest create "$target_image_base:latest" "${amend_args[@]}"
            docker manifest push "$target_image_base:latest"
            
            echo "âœ… åŒæ­¥å®Œæˆ: $target_image_base:latest"
            
            # æ›´æ–° README.md çš„æ›´æ–°æ—¶é—´
            today=$(date +'%Y-%m-%d')
            # å‡è®¾è¡¨æ ¼ç»“æ„ä¸ºï¼š| åºå· | æºé•œåƒ | Pull å‘½ä»¤ | ç”¨é€” | åŒæ­¥ | æ›´æ–°æ—¶é—´ |
            # åˆ—å·:            $1  $2     $3       $4        $5    $6      $7
            awk -F'|' -v img_name="$target_image" -v date="$today" '
              BEGIN{OFS=FS}
              # åŒ¹é…åŒ…å« `ghcr.io/.../é•œåƒå` çš„è¡Œï¼Œå¹¶ä¸”åŒæ­¥åˆ—(ç¬¬6åˆ—)ä¸º âœ”ï¸
              $4 ~ "`ghcr.io/.*/" img_name "(:[^`]+)?`" && $6 ~ /âœ”ï¸/ {
                  $7 = " " date " "; # æ›´æ–°ç¬¬7åˆ—
                  print;
                  next
              }
              {print}
            ' README.md > README.tmp && mv README.tmp README.md
            
            git config --global user.name "github-actions[bot]"
            git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add README.md
            if ! git diff --staged --quiet; then
              git commit -m "chore(sync): æ›´æ–°é•œåƒ [$target_image] çš„åŒæ­¥æ—¶é—´"
              git push
            else
              echo "README.md æ— å˜æ›´ï¼Œæ— éœ€æäº¤ã€‚"
            fi
          done < combined-list.txt
