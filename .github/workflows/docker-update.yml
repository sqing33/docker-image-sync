name: 更新 Docker 镜像 → 定时更新 ghcr.io

on:
  schedule:
    # 每天的 UTC 时间 16:00 (北京时间 00:00) 运行
    - cron: "0 16 * * *"
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 检出仓库
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 2. 安装依赖
        run: sudo apt-get update && sudo apt-get install -y jq skopeo

      # 步骤 3-5 (提取镜像列表) 保持不变
      - name: 3. 提取目标镜像名称
        id: extract-target-images
        run: |
          owner_lowercase=$(echo "${{ github.repository_owner }}" | tr 'A-Z' 'a-z')
          awk -F '|' '
          /^### 已同步的 Docker 镜像/ {capture=1; next}
          capture && /^\| [0-9]+/ {
              sync_col=$6; gsub(/^[ \t]+|[ \t]+$/, "", sync_col);
              if (sync_col != "✔️") next;
              gsub(/^[ \t]+|[ \t]+$/, "", $4); gsub(/`/, "", $4);
              print $4
          }
          /^### / && capture && !/已同步/ {capture=0}
          ' README.md | grep -vE '^源镜像$|^-+$' | sed '/^$/d' | \
          sed "s|^ghcr.io/$owner_lowercase/||" | \
          sed 's/:[^:]*$//' > target-image-list.txt
          echo "===== 将要检查的目标镜像列表 ====="
          cat target-image-list.txt

      - name: 4. 提取源镜像名称
        id: extract-source-images
        run: |
          awk -F '|' '
          /^### 已同步的 Docker 镜像/ {capture=1; next}
          capture && /^\| [0-9]+/ {
              sync_col=$6; gsub(/^[ \t]+|[ \t]+$/, "", sync_col);
              if (sync_col != "✔️") next;
              gsub(/^[ \t]+|[ \t]+$/, "", $3); gsub(/`/, "", $3);
              print $3
          }
          /^### / && capture && !/已同步/ {capture=0}
          ' README.md | grep -vE '^源镜像$|^-+$' | sed '/^$/d' > source-image-list.txt
          echo "===== 对应的源镜像列表 ====="
          cat source-image-list.txt

      - name: 5. 合并镜像列表
        run: |
          if [ ! -s source-image-list.txt ] || [ ! -s target-image-list.txt ]; then
            echo "错误：源或目标镜像列表为空，请检查 README.md 表格格式。"
            exit 1
          fi
          paste -d '|' source-image-list.txt target-image-list.txt > combined-list.txt
          echo "===== 合并后的镜像检查列表 ====="
          cat combined-list.txt

      # 步骤 6a, 6b, 7 (登录) 保持不变
      - name: 6a. 检查 Docker Hub 凭证是否存在
        id: check_dockerhub_creds
        run: |
          if [ -n "${{ secrets.DOCKERHUB_USERNAME }}" ] && [ -n "${{ secrets.DOCKERHUB_TOKEN }}" ]; then
            echo "present=true" >> "$GITHUB_OUTPUT"
          else
            echo "present=false" >> "$GITHUB_OUTPUT"
          fi

      - name: 6b. 登录到 Docker Hub (如果凭证存在)
        if: steps.check_dockerhub_creds.outputs.present == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: 7. 登录到 GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      # --- 这是最终优化的同步步骤 ---
      - name: 8. 检查并同步镜像
        env:
          GHCR_USER: ${{ github.repository_owner }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          set -eo pipefail

          # --- 函数定义区 ---
          skopeo_inspect_with_retry() {
            local __resultvar=$1
            local image_uri=$2
            local creds_flag=$3
            local creds_value=$4
            local manifest_output=""
            for i in {1..3}; do
              echo "Attempt $i to inspect $image_uri..."
              manifest_output=$(skopeo inspect --raw "$creds_flag" "$creds_value" "$image_uri" 2>/dev/null || echo "")
              if [ -n "$manifest_output" ]; then
                eval $__resultvar="'$manifest_output'"
                return 0
              fi
              if [ $i -lt 3 ]; then
                echo "Inspect failed. Retrying in 5 seconds..."
                sleep 5
              fi
            done
            echo "❌ Failed to inspect $image_uri after 3 attempts."
            eval $__resultvar=""
            return 1
          }

          get_digest_for_arch() {
            local manifest_content=$1; local arch_name=$2
            if [ -z "$manifest_content" ]; then echo ""; return; fi
            if echo "$manifest_content" | jq -e '.manifests' > /dev/null 2>&1; then
              echo "$manifest_content" | jq -r --arg arch "$arch_name" '.manifests[] | select(.platform.architecture == $arch) | .digest' | head -n 1
            else
              echo "$manifest_content" | jq -r '.digest // empty'
            fi
          }
          
          echo "===== 开始同步镜像 ====="
          
          while IFS='|' read -r source_image target_image; do
            echo "────────────────────────────────────────"
            echo "处理镜像: $target_image (源镜像: $source_image)"
            
            if [[ "$source_image" == *:* ]]; then source_image_name_tag="$source_image"; else source_image_name_tag="$source_image:latest"; fi
            owner_lowercase=$(echo "$GHCR_USER" | tr 'A-Z' 'a-z')
            target_image_name_tag="ghcr.io/$owner_lowercase/$target_image:latest"
            
            SOURCE_IMAGE_URI="docker://$source_image_name_tag"
            TARGET_IMAGE_URI="docker://$target_image_name_tag"

            # 准备认证信息
            DOCKERHUB_CREDS="$DOCKERHUB_USERNAME:$DOCKERHUB_TOKEN"
            GHCR_CREDS="$GHCR_USER:${{ secrets.GITHUB_TOKEN }}"
            
            source_creds_flag=""; source_creds_value=""
            if [[ "$source_image_name_tag" != ghcr.io* ]] && [ -n "$DOCKERHUB_USERNAME" ]; then
              source_creds_flag="--src-creds"; source_creds_value="$DOCKERHUB_CREDS"
            elif [[ "$source_image_name_tag" == ghcr.io* ]]; then
              source_creds_flag="--src-creds"; source_creds_value="$GHCR_CREDS"
            fi
            
            source_manifest=""; target_manifest=""
            skopeo_inspect_with_retry source_manifest "$SOURCE_IMAGE_URI" "$source_creds_flag" "$source_creds_value" || continue
            if [ -z "$source_manifest" ]; then continue; fi
            skopeo_inspect_with_retry target_manifest "$TARGET_IMAGE_URI" "--dest-creds" "$GHCR_CREDS"

            ARCHS_TO_CHECK="amd64 arm64 arm"; need_update=false
            if [ -z "$target_manifest" ]; then
              need_update=true; echo "目标镜像不存在，判定需要同步。"
            else
              for arch in $ARCHS_TO_CHECK; do
                source_digest_for_arch=$(get_digest_for_arch "$source_manifest" "$arch")
                if [ -z "$source_digest_for_arch" ]; then continue; fi
                target_digest_for_arch=$(get_digest_for_arch "$target_manifest" "$arch")
                echo "检查架构 '$arch': 源[${source_digest_for_arch:0:12}] <=> 目标[${target_digest_for_arch:0:12}]"
                if [ "$source_digest_for_arch" != "$target_digest_for_arch" ]; then
                  need_update=true; echo "发现不匹配的摘要，判定需要同步。"; break
                fi
              done
            fi

            if [ "$need_update" = "false" ]; then
              echo "✅ 所有已检查架构的摘要均匹配，跳过同步。"
              continue
            fi

            echo "开始使用 skopeo copy 同步..."
            if skopeo copy --all "$source_creds_flag" "$source_creds_value" --dest-creds "$GHCR_CREDS" "$SOURCE_IMAGE_URI" "$TARGET_IMAGE_URI"; then
              echo "✅ 镜像同步成功: $target_image_name_tag"
            else
              echo "❌ 镜像同步失败。"; continue
            fi

            today=$(date +'%Y-%m-%d')
            awk -F'|' -v img_name="$target_image" -v date="$today" 'BEGIN{OFS=FS} $4 ~ "`ghcr.io/.*/" img_name "(:[^`]+)?`" && $6 ~ /✔️/ { $7 = " " date " "; print; next } {print}' README.md > README.tmp && mv README.tmp README.md
            
            git config --global user.name "github-actions[bot]"
            git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add README.md
            if ! git diff --staged --quiet; then
              git commit -m "chore(sync): 更新镜像 [$target_image] 的同步时间"
              git push
            else
              echo "README.md 无变更，无需提交。"
            fi
          done < combined-list.txt
