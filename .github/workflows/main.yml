name: å°† Docker é•œåƒåŒæ­¥åˆ° ghcr.io

permissions:
  packages: write
  contents: write

on:
  workflow_dispatch:
    inputs:
      images:
        description: "è¦åŒæ­¥çš„ Docker é•œåƒåˆ—è¡¨ï¼Œæ ¼å¼ä¸º 'é•œåƒ1,é•œåƒ2,é•œåƒ3'"
        required: true
        default: ""
      tags:
        description: "å¯¹åº”çš„ Docker é•œåƒç‰ˆæœ¬åˆ—è¡¨ï¼Œæ ¼å¼ä¸º 'ç‰ˆæœ¬1,ç‰ˆæœ¬2,ç‰ˆæœ¬3'ï¼Œå¦‚æœæŸä¸ªé•œåƒä¸éœ€è¦æŒ‡å®šç‰ˆæœ¬ï¼Œåˆ™ç”¨é€—å·å¡«å……ï¼Œä¾‹å¦‚ ',,1.0' è¡¨ç¤ºç¬¬ä¸‰ä¸ªé•œåƒä½¿ç”¨ 1.0 ç‰ˆæœ¬ï¼Œå‰ä¸¤ä¸ªä½¿ç”¨é»˜è®¤çš„ latest"
        required: false
        default: ""
      ghcr_names:
        description: "å¯¹åº”çš„åŒæ­¥åçš„é•œåƒåç§°åˆ—è¡¨ï¼Œæ ¼å¼ä¸º 'åç§°1,åç§°2,åç§°3'ï¼Œå¦‚æœæŸä¸ªé•œåƒä¸éœ€è¦æŒ‡å®šåç§°ï¼Œåˆ™ç”¨é€—å·å¡«å……ï¼Œä¾‹å¦‚ ',,my-image' è¡¨ç¤ºç¬¬ä¸‰ä¸ªé•œåƒåŒæ­¥ååç§°ä¸º my-imageï¼Œå‰ä¸¤ä¸ªè‡ªåŠ¨æå–"
        required: false
        default: ""

jobs:
  docker-image-sync:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.loop_images.outputs.matrix }}
    steps:
      - name: å®‰è£…ä¾èµ–å·¥å…·
        run: sudo apt-get update && sudo apt-get install -y jq skopeo

      - name: å¤„ç†è¾“å…¥å¹¶å¾ªç¯åŒæ­¥é•œåƒ
        id: loop_images
        run: |
          IFS=',' read -r -a image_array <<< "${{ inputs.images }}"
          IFS=',' read -r -a tag_array <<< "${{ inputs.tags }}"
          IFS=',' read -r -a ghcr_name_array <<< "${{ inputs.ghcr_names }}"

          matrix_json='{"include":[]}'

          for i in "${!image_array[@]}"; do
            current_image="${image_array[$i]}"
            current_tag="${tag_array[$i]:-latest}"
            current_ghcr_name="${ghcr_name_array[$i]}"

            if [ -z "$current_image" ]; then
              echo "è­¦å‘Šï¼šç¬¬ $((i+1)) ä¸ªé•œåƒåç§°ä¸ºç©ºï¼Œå·²è·³è¿‡ã€‚"
              continue
            fi

            matrix_json=$(echo "$matrix_json" | jq --arg image "$current_image" --arg tag "$current_tag" --arg ghcr_name "$current_ghcr_name" '.include += [{"dockerhub_image": $image, "tag": $tag, "ghcr_image": $ghcr_name}]')
          done
          echo "matrix<<EOF" >> $GITHUB_OUTPUT
          echo "$matrix_json" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: è®¾ç½® GHCR_USER ç¯å¢ƒå˜é‡
        run: echo "GHCR_USER=$(echo '${{ github.actor }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: ç™»å½•åˆ° GitHub å®¹å™¨æ³¨å†Œè¡¨
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ env.GHCR_USER }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

  sync_single_image:
    needs: docker-image-sync # ç¡®ä¿ docker-image-sync ä»»åŠ¡åç§°æ­£ç¡®
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.docker-image-sync.outputs.matrix) }}
    steps:
      - name: è®¾ç½®ç¯å¢ƒå˜é‡
        run: |
          # è‡ªåŠ¨è·å–æ‰€æœ‰å¯ç”¨æ¶æ„
          echo "ğŸ”„ è‡ªåŠ¨è·å–æ‰€æœ‰å¯ç”¨æ¶æ„..."
          RAW_MANIFEST=$(skopeo inspect --raw "docker://${{ matrix.dockerhub_image }}:${{ matrix.tag }}")
          
          # è·å–æœ‰æ•ˆæ¶æ„åˆ—è¡¨
          if echo "$RAW_MANIFEST" | jq -e '.manifests' > /dev/null 2>&1; then
            ARCHS=$(echo "$RAW_MANIFEST" | jq -r '.manifests[].platform.architecture' | sort -u | grep -E 'amd64|arm64|arm|386|ppc64le|s390x|mips64le' | tr '\n' ',' | sed 's/,$//')
          else
            ARCH=$(echo "$RAW_MANIFEST" | jq -r '.architecture')
            ARCHS=$( [[ "$ARCH" =~ ^(amd64|arm64|arm|386|ppc64le|s390x|mips64le)$ ]] && echo "$ARCH" || echo "")
          fi
          
          if [ -z "$ARCHS" ]; then
            echo "âŒ æœªæ‰¾åˆ°æ”¯æŒçš„æ¶æ„ï¼Œä½¿ç”¨é»˜è®¤æ¶æ„ amd64"
            ARCHS="amd64"
          fi
          echo "ARCHS_STR=$(echo "$ARCHS" | tr ',' ' ')" >> $GITHUB_ENV

          # è®¾ç½® IMAGE_NAME
          if [ -z "${{ matrix.ghcr_image }}" ]; then
            IMAGE_NAME=$(basename "${{ matrix.dockerhub_image }}")
          else
            IMAGE_NAME="${{ matrix.ghcr_image }}"
          fi
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV
          # GHCR_USER ç¯å¢ƒå˜é‡å·²åœ¨ docker-image-sync job ä¸­è®¾ç½®

      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      # ç™»å½•æ­¥éª¤å·²ç§»åŠ¨åˆ° docker-image-sync job

      # è®¾ç½® Docker Buildx æ­¥éª¤å·²ç§»åŠ¨åˆ° docker-image-sync job

      - name: æ‹‰å–å¹¶æ¨é€å¤šæ¶æ„é•œåƒ
        run: | # æ³¨æ„ï¼šè¿™é‡Œæ‰€æœ‰çš„ inputs.xxx éƒ½éœ€è¦æ”¹æˆ matrix.xxx
          ARCHS=(${{ env.ARCHS_STR }})
          declare -a VALID_ARCHS=()
          FULL_MANIFEST=$(skopeo inspect --raw "docker://${{ matrix.dockerhub_image }}:${{ matrix.tag }}" | jq .)

          for arch in "${ARCHS[@]}"; do
            echo "ğŸ”„ æ­£åœ¨æ£€æŸ¥ $arch æ¶æ„æ”¯æŒ..."
            if echo "$FULL_MANIFEST" | jq -e --arg arch "$arch" '.manifests[] | select(.platform.architecture == $arch)' >/dev/null 2>&1; then
              echo "âœ… ç¡®è®¤å­˜åœ¨ $arch æ¶æ„é•œåƒ"
              VALID_ARCHS+=("$arch")
              
              echo "ğŸš€ æ­£åœ¨åŒæ­¥ $arch æ¶æ„..."
              docker pull --platform "linux/$arch" "${{ matrix.dockerhub_image }}:${{ matrix.tag }}"
              docker tag "${{ matrix.dockerhub_image }}:${{ matrix.tag }}" \
                "ghcr.io/${{ env.GHCR_USER }}/${{ env.IMAGE_NAME }}:${{ matrix.tag }}-$arch"
              docker push "ghcr.io/${{ env.GHCR_USER }}/${{ env.IMAGE_NAME }}:${{ matrix.tag }}-$arch"
            else
              echo "âš ï¸ è­¦å‘Šï¼šæ‰¾ä¸åˆ° $arch æ¶æ„é•œåƒï¼Œå·²è·³è¿‡"
            fi
            echo "----------------------------------------"
          done

          if [ ${#VALID_ARCHS[@]} -eq 0 ]; then 
            echo "âŒ æ‰€æœ‰æŒ‡å®šæ¶æ„å‡ä¸å­˜åœ¨ï¼Œåœæ­¢åŒæ­¥"
            exit 1 
          fi 
          echo "VALID_ARCHS=${VALID_ARCHS[*]}" >> $GITHUB_ENV

      - name: åˆ›å»ºå¤šæ¶æ„ Manifest
        if: env.VALID_ARCHS != '' && needs.docker-image-sync.outputs.matrix != '' # ç¡®ä¿ matrix ä¸ä¸ºç©º
        run: |
          echo "æœ‰æ•ˆæ¶æ„åˆ—è¡¨ï¼š${{ env.VALID_ARCHS }}"
          declare -a MANIFEST_ARGS=()

          for arch in ${{ env.VALID_ARCHS }};
          do
            MANIFEST_ARGS+=(--amend "ghcr.io/${{ env.GHCR_USER }}/${{ env.IMAGE_NAME }}:${{ matrix.tag }}-$arch")
          done

          echo "ğŸ› ï¸ åˆ›å»ºå¤šæ¶æ„æ¸…å•..."
          docker manifest create "ghcr.io/${{ env.GHCR_USER }}/${{ env.IMAGE_NAME }}:${{ matrix.tag }}" \
            "${MANIFEST_ARGS[@]}" \
            --insecure

          echo "ğŸšš æ¨é€æ¸…å•..."
          docker manifest push "ghcr.io/${{ env.GHCR_USER }}/${{ env.IMAGE_NAME }}:${{ matrix.tag }}"

      - name: æ¸…ç†ä¸´æ—¶é•œåƒ
        run: |
          docker image prune -a --force
          if [ -n "${{ env.VALID_ARCHS }}" ]; then
            for arch in ${{ env.VALID_ARCHS }};
            do
              docker rmi "ghcr.io/${{ env.GHCR_USER }}/${{ env.IMAGE_NAME }}:${{ matrix.tag }}-$arch" || true
            done
          fi

      - name: åˆ›å»º docker-compose.yaml æ–‡ä»¶
        if: env.VALID_ARCHS != '' && needs.docker-image-sync.outputs.matrix != '' # ç¡®ä¿ matrix ä¸ä¸ºç©º
        run: |
          mkdir -p docker-compose
          cp docker-compose/example.yaml docker-compose/${{ env.IMAGE_NAME }}.yaml
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add docker-compose/${{ env.IMAGE_NAME }}.yaml
          git commit -m "æ·»åŠ  ${{ env.IMAGE_NAME }}.yaml æ–‡ä»¶"
          git push origin main

      - name: æ›´æ–° README.md æ–‡ä»¶
        if: env.VALID_ARCHS != '' && needs.docker-image-sync.outputs.matrix != '' # ç¡®ä¿ matrix ä¸ä¸ºç©º
        run: |
          # æå–ç°æœ‰è¡¨æ ¼æ•°æ®è¡Œ
          data_lines=$(sed -n '/^### æœ¬ä»“åº“å·²åŒæ­¥çš„ Docker é•œåƒ/,/^[^|]/ { /^| [0-9]/p }' README.md)

          # æå–ç°æœ‰é•œåƒåç§°åˆ—è¡¨
          existing_images=$(awk -F '|' '
          /^### æœ¬ä»“åº“å·²åŒæ­¥çš„ Docker é•œåƒ/ {capture=1; next}
          capture && /^\| [0-9]+/ {
              gsub(/^[ \t]+|[ \t]+$/, "", $2);
              gsub(/`/, "", $2);
              print $2
          }
          /^[^|]/ {capture=0}
          ' README.md | grep -vE '^æºé•œåƒ$|^-+$' | sed '/^$/d')

          # è·å–å½“å‰é•œåƒåç§°
          current_image_name_for_readme=$(echo "${{ matrix.dockerhub_image }}" | tr '[:upper:]' '[:lower:]') # ä½¿ç”¨ matrix.dockerhub_image

          echo "Existing images: $existing_images"
          echo "Current image for README: $current_image_name_for_readme"

          # æ£€æŸ¥é•œåƒæ˜¯å¦å·²å­˜åœ¨
          if echo "$existing_images" | grep -qxF "$current_image_name_for_readme"; then
              echo "é•œåƒ ${{ matrix.dockerhub_image }} å·²å­˜åœ¨ï¼Œè·³è¿‡ README æ›´æ–°"
          else
              echo "æ·»åŠ æ–°é•œåƒ ${{ matrix.dockerhub_image }} åˆ° README"

              # è®¡ç®—å½“å‰é•œåƒæ•°é‡
              count=$(echo "$data_lines" | wc -l)
              new_count=$((count + 1))

              # ç”Ÿæˆ pull å‘½ä»¤
              if [ "${{ matrix.tag }}" = "latest" ]; then
                pull_cmd="ghcr.nju.edu.cn/${{ env.GHCR_USER }}/${{ env.IMAGE_NAME }}"
              else
                pull_cmd="ghcr.nju.edu.cn/${{ env.GHCR_USER }}/${{ env.IMAGE_NAME }}:${{ matrix.tag }}"
              fi

              # ä¸ºæ¯ä¸ªé•œåƒåˆ›å»ºä¸€ä¸ªdocker-compose.yamlæ–‡ä»¶çš„é“¾æ¥
              compose_file="[${{ env.IMAGE_NAME }}.yaml](https://github.com/${{ github.repository }}/blob/main/docker-compose/${{ env.IMAGE_NAME }}.yaml)"

              # ç”Ÿæˆæ–°è¡¨æ ¼è¡Œ
              new_row="| $new_count | ${{ matrix.dockerhub_image }} | \`$pull_cmd\` | $compose_file |"

              # ç”Ÿæˆæ–°çš„è¡¨æ ¼å†…å®¹
              {
                echo "### æœ¬ä»“åº“å·²åŒæ­¥çš„ Docker é•œåƒ"
                echo ""
                echo "|   | æºé•œåƒ | pull é•œåƒ | docker-compose |"
                echo "| ---- | -------- | --------- | -------------- |"
                echo "$data_lines"
                echo "$new_row"
              } > new_table_content.txt

              # ä½¿ç”¨ awk æ›¿æ¢åŸå†…å®¹
              awk '
              /^### æœ¬ä»“åº“å·²åŒæ­¥çš„ Docker é•œåƒ/ {
                  while ((getline line < "new_table_content.txt") > 0) {
                      print line
                  }
                  close("new_table_content.txt")
                  while ((getline line) > 0) {
                      if (line ~ /^[^|]/) {
                          print line
                          break
                      }
                  }
                  next
              }
              { print }
              ' README.md > README.tmp && mv README.tmp README.md

              # æäº¤æ›´æ”¹
              git config --global user.name "GitHub Actions"
              git config --global user.email "actions@github.com"
              git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
              git add README.md
              git commit -m "æ›´æ–°README.mdï¼Œæ·»åŠ æ–°çš„é•œåƒè¡¨æ ¼æ¡ç›®"
              git push origin main
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
