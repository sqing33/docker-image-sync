name: å°† Docker é•œåƒåŒæ­¥åˆ° ghcr.io

permissions:
  packages: write
  contents: write

on:
  workflow_dispatch:
    inputs:
      dockerhub_image:
        description: "è¦åŒæ­¥çš„ Docker é•œåƒ"
        required: true
        default: ""
      tag:
        description: "Docker é•œåƒç‰ˆæœ¬"
        required: true
        default: "latest"
      image_description:
        description: "Docker é•œåƒçš„ä½œç”¨æè¿°"
        required: false
        default: ""
      ghcr_image:
        description: "åŒæ­¥çš„é•œåƒåç§°ï¼ˆç•™ç©ºåˆ™è‡ªåŠ¨æå–ï¼‰"
        required: false
        default: ""
      architectures:
        description: "è¦åŒæ­¥çš„æ¶æ„åˆ—è¡¨ï¼ˆé€—å·åˆ†éš”(ä¾‹:amd64,arm64)ï¼Œç•™ç©ºåˆ™åŒæ­¥æ‰€æœ‰å¯ç”¨æ¶æ„ï¼‰"
        required: false
        default: ""

jobs:
  docker-image-sync:
    runs-on: ubuntu-latest

    steps:
      - name: å®‰è£…ä¾èµ–å·¥å…·
        run: sudo apt-get update && sudo apt-get install -y jq skopeo

      - name: è®¾ç½®ç¯å¢ƒå˜é‡
        run: |
          # å¤„ç†æ¶æ„å‚æ•°
          if [ -z "${{ inputs.architectures }}" ]; then
            echo "ğŸ”„ æ£€æµ‹åˆ°æœªæŒ‡å®šæ¶æ„ï¼Œè‡ªåŠ¨è·å–æ‰€æœ‰å¯ç”¨æ¶æ„..."
            RAW_MANIFEST=$(skopeo inspect --raw "docker://${{ inputs.dockerhub_image }}:${{ inputs.tag }}")
            
            # è·å–æœ‰æ•ˆæ¶æ„åˆ—è¡¨
            if echo "$RAW_MANIFEST" | jq -e '.manifests' > /dev/null 2>&1; then
              ARCHS=$(echo "$RAW_MANIFEST" | jq -r '.manifests[].platform.architecture' | sort -u | grep -E 'amd64|arm64|arm|386|ppc64le|s390x|mips64le' | tr '\n' ',' | sed 's/,$//')
            else
              ARCH=$(echo "$RAW_MANIFEST" | jq -r '.architecture')
              ARCHS=$( [[ "$ARCH" =~ ^(amd64|arm64|arm|386|ppc64le|s390x|mips64le)$ ]] && echo "$ARCH" || echo "")
            fi
            
            if [ -z "$ARCHS" ]; then
              echo "âŒ æœªæ‰¾åˆ°æ”¯æŒçš„æ¶æ„ï¼Œä½¿ç”¨é»˜è®¤æ¶æ„ amd64"
              ARCHS="amd64"
            fi
            echo "ARCHS_STR=$(echo "$ARCHS" | tr ',' ' ')" >> $GITHUB_ENV
          else
            echo "ARCHS_STR=$(echo '${{ inputs.architectures }}' | tr ',' ' ')" >> $GITHUB_ENV
          fi

          # è®¾ç½® IMAGE_NAME
          if [ -z "${{ inputs.ghcr_image }}" ]; then
            IMAGE_NAME=$(basename "${{ inputs.dockerhub_image }}")
          else
            IMAGE_NAME="${{ inputs.ghcr_image }}"
          fi
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV
          echo "GHCR_USER=$(echo '${{ github.actor }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: ç™»å½•åˆ° GitHub å®¹å™¨æ³¨å†Œè¡¨
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ env.GHCR_USER }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: æ‹‰å–å¹¶æ¨é€å¤šæ¶æ„é•œåƒ
        run: |
          ARCHS=(${{ env.ARCHS_STR }})
          declare -a VALID_ARCHS=()
          FULL_MANIFEST=$(skopeo inspect --raw "docker://${{ inputs.dockerhub_image }}:${{ inputs.tag }}" | jq .)

          for arch in "${ARCHS[@]}"; do
            echo "ğŸ”„ æ­£åœ¨æ£€æŸ¥ $arch æ¶æ„æ”¯æŒ..."
            if echo "$FULL_MANIFEST" | jq -e --arg arch "$arch" '.manifests[] | select(.platform.architecture == $arch)' >/dev/null 2>&1; then
              echo "âœ… ç¡®è®¤å­˜åœ¨ $arch æ¶æ„é•œåƒ"
              VALID_ARCHS+=("$arch")
              
              echo "ğŸš€ æ­£åœ¨åŒæ­¥ $arch æ¶æ„..."
              docker pull --platform "linux/$arch" "${{ inputs.dockerhub_image }}:${{ inputs.tag }}"
              docker tag "${{ inputs.dockerhub_image }}:${{ inputs.tag }}" \
                "ghcr.io/${{ env.GHCR_USER }}/${{ env.IMAGE_NAME }}:${{ inputs.tag }}-$arch"
              docker push "ghcr.io/${{ env.GHCR_USER }}/${{ env.IMAGE_NAME }}:${{ inputs.tag }}-$arch"
            else
              echo "âš ï¸ è­¦å‘Šï¼šæ‰¾ä¸åˆ° $arch æ¶æ„é•œåƒï¼Œå·²è·³è¿‡"
            fi
            echo "----------------------------------------"
          done

          if [ ${#VALID_ARCHS[@]} -eq 0 ]; then 
            echo "âŒ æ‰€æœ‰æŒ‡å®šæ¶æ„å‡ä¸å­˜åœ¨ï¼Œåœæ­¢åŒæ­¥"
            exit 1 
          fi 
          echo "VALID_ARCHS=${VALID_ARCHS[*]}" >> $GITHUB_ENV

      - name: åˆ›å»ºå¤šæ¶æ„ Manifest
        if: env.VALID_ARCHS != ''
        run: |
          echo "æœ‰æ•ˆæ¶æ„åˆ—è¡¨ï¼š${{ env.VALID_ARCHS }}"
          declare -a MANIFEST_ARGS=()

          for arch in ${{ env.VALID_ARCHS }}; do
            MANIFEST_ARGS+=(--amend "ghcr.io/${{ env.GHCR_USER }}/${{ env.IMAGE_NAME }}:${{ inputs.tag }}-$arch")
          done

          echo "ğŸ› ï¸ åˆ›å»ºå¤šæ¶æ„æ¸…å•..."
          docker manifest create "ghcr.io/${{ env.GHCR_USER }}/${{ env.IMAGE_NAME }}:${{ inputs.tag }}" \
            "${MANIFEST_ARGS[@]}" \
            --insecure

          echo "ğŸšš æ¨é€æ¸…å•..."
          docker manifest push "ghcr.io/${{ env.GHCR_USER }}/${{ env.IMAGE_NAME }}:${{ inputs.tag }}"

      - name: æ¸…ç†ä¸´æ—¶é•œåƒ
        run: |
          docker image prune -a --force
          if [ -n "${{ env.VALID_ARCHS }}" ]; then
            for arch in ${{ env.VALID_ARCHS }}; do
              docker rmi "ghcr.io/${{ env.GHCR_USER }}/${{ env.IMAGE_NAME }}:${{ inputs.tag }}-$arch" || true
            done
          fi

      - name: åˆ›å»º docker-compose.yaml æ–‡ä»¶
        if: env.VALID_ARCHS != ''
        run: |
          mkdir -p docker-compose
          cp docker-compose/example.yaml docker-compose/${{ env.IMAGE_NAME }}.yaml
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add docker-compose/${{ env.IMAGE_NAME }}.yaml
          git commit -m "æ·»åŠ  ${{ env.IMAGE_NAME }}.yaml æ–‡ä»¶"
          git push origin main

      - name: æ›´æ–° README.md æ–‡ä»¶
        if: env.VALID_ARCHS != ''
        run: |
          # æå–ç°æœ‰è¡¨æ ¼æ•°æ®è¡Œ
          data_lines=$(sed -n '/^### æœ¬ä»“åº“å·²åŒæ­¥çš„ Docker é•œåƒ/,/^[^|]/ { /^| [0-9]/p }' README.md)

          # æå–ç°æœ‰é•œåƒåç§°åˆ—è¡¨
          existing_images=$(awk -F '|' '
          /^### æœ¬ä»“åº“å·²åŒæ­¥çš„ Docker é•œåƒ/ {capture=1; next}
          capture && /^\| [0-9]+/ {
              gsub(/^[ \t]+|[ \t]+$/, "", $3);
              gsub(/`/, "", $3);
              print $3
          }
          /^[^|]/ {capture=0}
          ' README.md | grep -vE '^æºé•œåƒ$|^-+$' | sed '/^$/d')

          # è·å–å½“å‰é•œåƒåç§°
          current_image=$(echo "${{ inputs.dockerhub_image }}" | tr '[:upper:]' '[:lower:]')

          echo "Existing images: $existing_images"
          echo "Current image: $current_image"

          # æ£€æŸ¥é•œåƒæ˜¯å¦å·²å­˜åœ¨
          if echo "$existing_images" | grep -qxF "$current_image"; then
              echo "é•œåƒ ${{ inputs.dockerhub_image }} å·²å­˜åœ¨ï¼Œè·³è¿‡ README æ›´æ–°"
          else
              echo "æ·»åŠ æ–°é•œåƒ ${{ inputs.dockerhub_image }} åˆ° README"

              # è®¡ç®—å½“å‰é•œåƒæ•°é‡
              count=$(echo "$data_lines" | wc -l)
              new_count=$((count + 1))

              # ç”Ÿæˆ pull å‘½ä»¤
              if [ "${{ inputs.tag }}" = "latest" ]; then
                pull_cmd="docker pull ghcr.nju.edu.cn/${{ env.GHCR_USER }}/${{ env.IMAGE_NAME }}"
              else
                pull_cmd="docker pull ghcr.nju.edu.cn/${{ env.GHCR_USER }}/${{ env.IMAGE_NAME }}:${{ inputs.tag }}"
              fi

              # ä¸ºæ¯ä¸ªé•œåƒåˆ›å»ºä¸€ä¸ªdocker-compose.yamlæ–‡ä»¶çš„é“¾æ¥
              compose_file="[${{ env.IMAGE_NAME }}.yaml](https://github.com/${{ github.repository }}/blob/main/docker-compose/${{ env.IMAGE_NAME }}.yaml)"

              # ç”Ÿæˆæ–°è¡¨æ ¼è¡Œ
              new_row="| $new_count | ${{ inputs.dockerhub_image }} | ${{ inputs.image_description }} | \`$pull_cmd\` | $compose_file |"

              # ç”Ÿæˆæ–°çš„è¡¨æ ¼å†…å®¹
              {
                echo "### æœ¬ä»“åº“å·²åŒæ­¥çš„ Docker é•œåƒ"
                echo ""
                echo "|   | æºé•œåƒ | ç”¨é€” | pull å‘½ä»¤ | docker-compose |"
                echo "| ---- | -------- | ---- | --------- | -------------- |"
                echo "$data_lines"
                echo "$new_row"
              } > new_table_content.txt

              # ä½¿ç”¨ awk æ›¿æ¢åŸå†…å®¹
              awk '
              /^### æœ¬ä»“åº“å·²åŒæ­¥çš„ Docker é•œåƒ/ {
                  while ((getline line < "new_table_content.txt") > 0) {
                      print line
                  }
                  close("new_table_content.txt")
                  while ((getline line) > 0) {
                      if (line ~ /^[^|]/) {
                          print line
                          break
                      }
                  }
                  next
              }
              { print }
              ' README.md > README.tmp && mv README.tmp README.md

              # æäº¤æ›´æ”¹
              git config --global user.name "GitHub Actions"
              git config --global user.email "actions@github.com"
              git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
              git add README.md
              git commit -m "æ›´æ–°README.mdï¼Œæ·»åŠ æ–°çš„é•œåƒè¡¨æ ¼æ¡ç›®"
              git push origin main
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
